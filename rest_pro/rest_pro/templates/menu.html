<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Menu</title>
  <style>
    body { font-family: Arial; background: #f7f7f7; padding: 20px; }
    .container { max-width:1100px; margin:0 auto; }
    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:18px; margin-top:18px; }
    .card { background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 10px rgba(0,0,0,.06); text-align:center; }
    .card img { width:100%; height:180px; object-fit:cover; display:block; }
    .card-body { padding:12px; }
    .meta { color:#555; font-size:14px; margin:8px 0; }
    .price { font-weight:700; margin-top:6px; }
    .btn { padding:8px 12px; border-radius:6px; border:none; cursor:pointer; color:#fff; }
    .btn-primary{ background:#007bff; }
    .btn-warning{ background:#f0ad4e; }
    .btn-danger{ background:#dc3545; }
    .btn-small{ padding:6px 8px; font-size:13px; margin-left:6px; }
    .btn-green{ background:#28a745; }

    /* modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal { background:#fff; padding:18px; border-radius:8px; width:560px; max-width:96%; box-shadow:0 8px 30px rgba(0,0,0,.25); }
    .form-row{ display:flex; gap:10px; margin-bottom:8px; }
    .form-row input[type="text"], .form-row input[type="number"], textarea{ width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; }
    label{ font-size:13px; color:#333; display:block; margin-bottom:6px; }

    /* error box */
    .error-box { background:#ffe6e6; border:1px solid #ffb3b3; color:#900; padding:8px 12px; border-radius:6px; margin-top:8px; }
    .field-error { color:#900; font-size:13px; margin-top:6px; }

    /* GO TO CART BUTTON */
    .go-cart-btn{
      position: fixed;
      bottom: 22px;
      right: 24px;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 17px;
      background: #28a745;
      color: #fff;
      border: none;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(0,0,0,.15);
      display: none;
    }
  </style>
</head>
<body>

  <div class="container">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Restaurant Menu</h2>

      {% if role|default:''|lower == 'admin' %}
        <button class="btn btn-primary" onclick="openAddModal()">Add Item</button>
      {% endif %}
    </div>

    <div id="grid" class="grid">
      {% for item in menu %}
      <div class="card" data-id="{{ item.DishId }}">
        <img src="{{ item.Image }}" alt="{{ item.DishName }}">
        <div class="card-body">
          <h3>{{ item.DishName }}</h3>
          <div class="meta"><strong>Category:</strong> {{ item.Category }}</div>
          <div class="meta"><strong>Ingredients:</strong> {{ item.Ingredients }}</div>
          <div class="price">â‚¹{{ item.Price }}</div>

          {% if role|default:''|lower == 'admin' %}
            <button class="btn btn-warning btn-small" onclick="openEditModal({{ item.DishId }})">Update</button>
            <button class="btn btn-danger btn-small" onclick="deleteItem({{ item.DishId }})">Delete</button>
          {% else %}
            <button class="btn btn-green btn-small" onclick="addToCart('{{ item.DishId }}')">Add to Cart</button>
          {% endif %}
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  {% if role|default:''|lower != 'admin' %}
  <button id="goCartBtn" class="go-cart-btn" onclick="window.location.href='/orders/'">
    ðŸ›’ Go to Cart
  </button>
  {% endif %}

  <!-- ADD modal (unchanged) -->
  <div id="addBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Add New Dish</h3>
      <form id="addForm" onsubmit="event.preventDefault(); addDish();">
        <!-- full original add modal fields -->
        (your same add modal content remains untouched)
      </form>
    </div>
  </div>

  <!-- EDIT modal (unchanged) -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Edit Dish</h3>
      <form id="editForm" onsubmit="event.preventDefault(); updateDish();">
        <!-- full original edit modal fields -->
        (your same edit modal content remains untouched)
      </form>
    </div>
  </div>

<script>
/* ========== existing JS kept exactly as it is ========== */
/* getCookie(), clearFieldErrors(), addDish(), deleteItem(), updateDish(), modals etc. */
/* NOTHING removed */

function getCookie(name) {
  const v = document.cookie.split('; ').find(row => row.startsWith(name + '='));
  return v ? decodeURIComponent(v.split('=')[1]) : null;
}
const csrftoken = getCookie('csrftoken');

/* helpers to show errors */
function clearFieldErrors(prefix) {
  const fields = ['DishId','DishName','Price','Category','Ingredients','Image'];
  fields.forEach(f => {
    const el = document.getElementById(`${prefix}_${f}`);
    if (el) el.textContent = '';
  });
  const errContainer = document.getElementById(prefix === 'err_add' ? 'addErrors' : 'editErrors');
  if (errContainer) errContainer.innerHTML = '';
}

function showFieldErrors(prefix, errors) {
  clearFieldErrors(prefix);
  if (!errors) return;
  for (const [field, msgs] of Object.entries(errors)) {
    const id = `${prefix}_${field}`;
    const container = document.getElementById(id);
    if (container) {
      container.textContent = (Array.isArray(msgs) ? msgs.join(' ') : String(msgs));
    } else {
      const box = document.createElement('div');
      box.className = 'error-box';
      box.textContent = (Array.isArray(msgs) ? msgs.join(' ') : String(msgs));
      const parent = document.getElementById(prefix === 'err_add' ? 'addErrors' : 'editErrors');
      if (parent) parent.appendChild(box);
    }
  }
}

/* Add modal open/close */
function openAddModal(){
  document.getElementById('addBackdrop').style.display = 'flex';
  clearFieldErrors('err_add');
  const form = document.getElementById('addForm');
  if (form) form.reset();
}
function closeAddModal(){
  const backdrop = document.getElementById('addBackdrop');
  if (backdrop) backdrop.style.display = 'none';
  const form = document.getElementById('addForm');
  if (form) form.reset();
  clearFieldErrors('err_add');
}

/* Edit modal open/close */
function openEditModal(id){
  const card = document.querySelector(`.card[data-id="${id}"]`);
  if (!card) return alert('Card not found');
  document.getElementById('editDishId').value = id;
  document.getElementById('editDishName').value = card.querySelector('h3').textContent.trim();
  const metas = card.querySelectorAll('.meta');
  let cat = '', ing = '';
  metas.forEach(m => {
    if (m.textContent.includes('Category:')) cat = m.textContent.replace('Category:','').trim();
    if (m.textContent.includes('Ingredients:')) ing = m.textContent.replace('Ingredients:','').trim();
  });
  document.getElementById('editCategory').value = cat;
  document.getElementById('editIngredients').value = ing;
  const priceText = card.querySelector('.price') ? card.querySelector('.price').textContent.replace(/[^0-9.]/g,'') : '';
  document.getElementById('editPrice').value = priceText;
  clearFieldErrors('err_edit');
  document.getElementById('modalBackdrop').style.display = 'flex';
}
function closeModal(){
  const backdrop = document.getElementById('modalBackdrop');
  if (backdrop) backdrop.style.display = 'none';
  const form = document.getElementById('editForm');
  if (form) form.reset();
  clearFieldErrors('err_edit');
}

/* ADD Dish */
async function addDish(){
  const form = document.getElementById('addForm');
  if (!form) return alert('Add form not found');

  const submitBtn = document.getElementById('addSubmitBtn');
  submitBtn.disabled = true;

  const fd = new FormData(form);
  const idVal = fd.get('DishId');
  if (idVal && !Number.isNaN(Number(idVal))) fd.set('DishId', Number(idVal));
  const img = document.getElementById('addImage');
  if (img && img.files.length === 0) fd.delete('Image');

  clearFieldErrors('err_add');

  try {
    const res = await fetch('/add_item/', {
      method: 'POST',
      body: fd,
      credentials: 'include',
      headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
    });

    let data;
    try { data = await res.json(); } catch { data = null; }

    if (res.ok) {
      closeAddModal();
      const tmp = document.createElement('div');
      tmp.textContent = 'Dish added âœ“';
      tmp.style.position = 'fixed';
      tmp.style.top = '16px';
      tmp.style.right = '16px';
      tmp.style.background = '#d4edda';
      tmp.style.padding = '10px 14px';
      tmp.style.borderRadius = '6px';
      tmp.style.boxShadow = '0 2px 8px rgba(0,0,0,.1)';
      document.body.appendChild(tmp);
      setTimeout(()=> {
        document.body.removeChild(tmp);
        location.reload();
      }, 700);
    } else {
      showFieldErrors('err_add', data || {non_field_errors: [`Request failed: ${res.status}`]});
    }
  } catch (err) {
    showFieldErrors('err_add', {non_field_errors:['Network or server error']});
    console.error('addDish error:', err);
  } finally {
    submitBtn.disabled = false;
  }
}

/* DELETE Dish */
async function deleteItem(id){
  if (!confirm('Delete this item?')) return;
  try {
    const res = await fetch(`/remove_item/${id}/`, {
      method: 'DELETE',
      credentials: 'include',
      headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
    });
    let data;
    try { data = await res.json(); } catch { data = null; }
    if (res.ok){
      location.reload();
    } else {
      alert((data && (data.error || data.msg)) || `Delete failed: ${res.status}`);
    }
  } catch (err) {
    alert('Request failed');
    console.error(err);
  }
}

/* UPDATE Dish (PATCH + multipart/form-data) */
async function updateDish(){
  const form = document.getElementById('editForm');
  const submitBtn = document.getElementById('editSubmitBtn');
  submitBtn.disabled = true;

  const id = document.getElementById('editDishId').value;
  const fd = new FormData(form);
  const fileInput = document.getElementById('editImage');
  if (fileInput && fileInput.files.length === 0) fd.delete('Image');

  clearFieldErrors('err_edit');

  try {
    // PATCH with FormData: browser will set Content-Type with boundary automatically
    const res = await fetch(`/modify_item/${id}/`, {
      method: 'PATCH',
      body: fd,
      credentials: 'include',
      headers: csrftoken ? { 'X-CSRFToken': csrftoken } : {}
    });

    let data;
    try { data = await res.json(); } catch { data = null; }

    if (res.ok){
      closeModal();
      location.reload();
    } else {
      showFieldErrors('err_edit', data || {non_field_errors: [`Request failed: ${res.status}`]});
    }
  } catch (err) {
    showFieldErrors('err_edit', {non_field_errors:['Network or server error']});
    console.error(err);
  } finally {
    submitBtn.disabled = false;
  }
}

/* -------- NEW Add to Cart function -------- */
function addToCart(id){
  fetch(`/add_to_cart/${id}/`, {
    method: "POST",
    credentials: "include"
  })
  .then(r => r.json())
  .then(data => {
    alert(data.msg || data.error || "Added to cart");
    const btn = document.getElementById("goCartBtn");
    if (btn) btn.style.display = "block";
  })
  .catch(() => alert("Network error"));
}
</script>

</body>
</html>
